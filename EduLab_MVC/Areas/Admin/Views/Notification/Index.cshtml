@{
    ViewData["Title"] = "لوحة إدارة الإشعارات";
}

<div class="min-h-screen p-6">
    <div class="max-w-7xl mx-auto space-y-8">
        <!-- Header Section -->
        <div class="card p-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex items-center space-x-4 space-x-reverse mb-6 md:mb-0">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-r from-primary-500 to-primary-600 flex items-center justify-center shadow-lg">
                         <i class="fas fa-bell text-primary-600 text-3xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold">مركز الإشعارات</h1>
                        <p class="text-gray-600 dark:text-gray-400 mt-2">أرسل إشعارات مخصصة للمستخدمين بناءً على مجموعاتهم</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Notification Form -->
            <div class="lg:col-span-2 space-y-8">
                <div class="card p-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-paper-plane ml-3 text-primary-600"></i>
                        إنشاء إشعار جديد
                    </h2>

                    <!-- Notification Type -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">نوع الإشعار</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <div class="radio-card selected" onclick="selectNotificationType(1)">
                                <div class="flex flex-col items-center text-center p-3">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mb-2">
                                        <i class="fas fa-bullhorn text-blue-600"></i>
                                    </div>
                                    <span class="font-semibold text-sm">ترويجي</span>
                                </div>
                            </div>

                            <div class="radio-card" onclick="selectNotificationType(0)">
                                <div class="flex flex-col items-center text-center p-3">
                                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mb-2">
                                        <i class="fas fa-cog text-gray-600"></i>
                                    </div>
                                    <span class="font-semibold text-sm">نظام</span>
                                </div>
                            </div>

                            <div class="radio-card" onclick="selectNotificationType(2)">
                                <div class="flex flex-col items-center text-center p-3">
                                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mb-2">
                                        <i class="fas fa-book text-green-600"></i>
                                    </div>
                                    <span class="font-semibold text-sm">دورة</span>
                                </div>
                            </div>

                            <div class="radio-card" onclick="selectNotificationType(3)">
                                <div class="flex flex-col items-center text-center p-3">
                                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center mb-2">
                                        <i class="fas fa-user-plus text-purple-600"></i>
                                    </div>
                                    <span class="font-semibold text-sm">تسجيل</span>
                                </div>
                            </div>

                            <div class="radio-card" onclick="selectNotificationType(4)">
                                <div class="flex flex-col items-center text-center p-3">
                                    <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center mb-2">
                                        <i class="fas fa-clock text-yellow-600"></i>
                                    </div>
                                    <span class="font-semibold text-sm">تذكير</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recipients -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">المستلمون</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="checkbox-card selected" onclick="toggleRecipient('all')">
                                <div class="flex items-center">
                                    <div class="w-5 h-5 border-2 border-primary-600 bg-primary-600 rounded mr-3 flex items-center justify-center">
                                        <i class="fas fa-check text-white text-xs"></i>
                                    </div>
                                    <div>
                                        <span class="font-semibold">كل المستخدمين</span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">جميع المستخدمين المسجلين</p>
                                    </div>
                                </div>
                            </div>

                            <div class="checkbox-card" onclick="toggleRecipient('students')">
                                <div class="flex items-center">
                                    <div class="w-5 h-5 border-2 border-gray-400 rounded mr-3 flex items-center justify-center">
                                        <i class="fas fa-check text-white text-xs hidden"></i>
                                    </div>
                                    <div>
                                        <span class="font-semibold">الطلاب فقط</span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">المستخدمين ذوي دور الطالب</p>
                                    </div>
                                </div>
                            </div>

                            <div class="checkbox-card" onclick="toggleRecipient('instructors')">
                                <div class="flex items-center">
                                    <div class="w-5 h-5 border-2 border-gray-400 rounded mr-3 flex items-center justify-center">
                                        <i class="fas fa-check text-white text-xs hidden"></i>
                                    </div>
                                    <div>
                                        <span class="font-semibold">المدربون فقط</span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">المستخدمين ذوي دور المدرب</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Send Options -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">خيارات الإرسال</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="checkbox-card selected" onclick="toggleSendOption('notification')">
                                <div class="flex items-center">
                                    <input type="checkbox" id="sendNotificationOption" class="hidden" checked>
                                    <div class="w-5 h-5 border-2 border-primary-600 bg-primary-600 rounded mr-3 flex items-center justify-center">
                                        <i class="fas fa-check text-white text-xs"></i>
                                    </div>
                                    <div>
                                        <span class="font-semibold">إرسال بريد إلكتروني</span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">إرسال رسالة بريد إلكتروني للمستخدمين</p>
                                    </div>
                                </div>
                            </div>

                            <div class="checkbox-card selected" onclick="toggleSendOption('email')">
                                <div class="flex items-center">
                                    <input type="checkbox" id="sendEmailOption" class="hidden" checked>
                                    <div class="w-5 h-5 border-2 border-primary-600 bg-primary-600 rounded mr-3 flex items-center justify-center">
                                        <i class="fas fa-check text-white text-xs"></i>
                                    </div>
                                    <div>
                                        <span class="font-semibold">إرسال إشعار داخل النظام</span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">إظهار إشعار في لوحة تحكم المستخدم</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Message Details -->
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-4">تفاصيل الرسالة</h3>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        عنوان الرسالة *
                                    </label>
                                    <input type="text" id="notificationTitle" class="form-control" placeholder="أدخل عنوان الرسالة..." maxlength="200">
                                    <div class="text-xs text-gray-500 mt-1" id="titleCounter">0/200</div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        محتوى الرسالة *
                                    </label>
                                    <textarea id="notificationContent" class="form-control" rows="6" placeholder="أدخل محتوى الرسالة..." maxlength="2000"></textarea>
                                    <div class="text-xs text-gray-500 mt-1" id="contentCounter">0/2000</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <button class="btn-primary flex-1 flex items-center justify-center" onclick="sendNotification()">
                            <i class="fas fa-paper-plane ml-3"></i> إرسال الإشعار
                        </button>
                        <button class="px-8 py-4 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-all duration-300 flex items-center justify-center" onclick="resetForm()">
                            <i class="fas fa-times ml-3"></i> إلغاء
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-8">
                <!-- Quick Templates -->
                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-clone ml-3 text-primary-600"></i>
                        القوالب السريعة
                    </h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-6">انقر على أي قالب لتعبئة النموذج تلقائيًا</p>

                    <div class="space-y-5">
                        <div class="template-card p-5 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900" onclick="applyTemplate('welcome')">
                            <div class="flex items-start">
                                <div class="w-12 h-12 rounded-xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center shadow-sm">
                                    <i class="fas fa-graduation-cap text-blue-600 dark:text-blue-400"></i>
                                </div>
                                <div class="mr-4 flex-1">
                                    <h4 class="font-bold text-lg">ترحيب بالطلاب الجدد</h4>
                                    <p class="text-gray-600 dark:text-gray-400 mt-2">مرحبًا بك في منصتنا! نحن سعداء بانضمامك إلينا.</p>
                                    <div class="mt-2">
                                        <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">ترويجي</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="template-card p-5 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900" onclick="applyTemplate('new_course')">
                            <div class="flex items-start">
                                <div class="w-12 h-12 rounded-xl bg-green-100 dark:bg-green-900/30 flex items-center justify-center shadow-sm">
                                    <i class="fas fa-bullhorn text-green-600 dark:text-green-400"></i>
                                </div>
                                <div class="mr-4 flex-1">
                                    <h4 class="font-bold text-lg">إعلان عن دورة جديدة</h4>
                                    <p class="text-gray-600 dark:text-gray-400 mt-2">يسرنا الإعلان عن إطلاق دورة جديدة في مجال البرمجة.</p>
                                    <div class="mt-2">
                                        <span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded">دورة</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="template-card p-5 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900" onclick="applyTemplate('system_update')">
                            <div class="flex items-start">
                                <div class="w-12 h-12 rounded-xl bg-gray-100 dark:bg-gray-900/30 flex items-center justify-center shadow-sm">
                                    <i class="fas fa-cog text-gray-600 dark:text-gray-400"></i>
                                </div>
                                <div class="mr-4 flex-1">
                                    <h4 class="font-bold text-lg">تحديثات النظام</h4>
                                    <p class="text-gray-600 dark:text-gray-400 mt-2">سيتم إجراء بعض التحديثات على النظام.</p>
                                    <div class="mt-2">
                                        <span class="inline-block bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">نظام</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-bar ml-3 text-primary-600"></i>
                        إحصائيات سريعة
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                            <span class="font-semibold">إجمالي المستخدمين</span>
                            <span class="bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-sm" id="totalUsersCount">...</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                            <span class="font-semibold">الطلاب</span>
                            <span class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 px-2 py-1 rounded text-sm" id="studentsCount">...</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                            <span class="font-semibold">المدربون</span>
                            <span class="bg-purple-100 dark:bg-purple-800 text-purple-800 dark:text-purple-200 px-2 py-1 rounded text-sm" id="instructorsCount">...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
    }

    .dark .card {
        background: #1e293b;
        border-color: #334155;
    }

    .btn-primary {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 12px 24px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
        }

    .template-card {
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }

        .template-card:hover {
            transform: translateY(-2px);
            border-color: #2563eb;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #cbd5e1;
        border-radius: 12px;
        transition: all 0.3s ease;
        background: white;
    }

        .form-control:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

    .dark .form-control {
        background: #334155;
        border-color: #475569;
        color: white;
    }

    .checkbox-card, .radio-card {
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .checkbox-card.selected, .radio-card.selected {
        border-color: #2563eb;
        background: #f0f9ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
    }

    .dark .checkbox-card.selected, .dark .radio-card.selected {
        border-color: #2563eb;
        background: #1e3a8a;
    }

    .border-red-500 {
        border-color: #ef4444 !important;
    }
</style>

<script>
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        // Set default recipients
        toggleRecipient('all');
            // Add input event listeners for character counters
    document.getElementById('notificationTitle').addEventListener('input', function() {
        updateTitleCounter();
        // إزالة نمط الخطأ عند البدء بالكتابة
        this.classList.remove('border-red-500', 'border-2');
    });

    document.getElementById('notificationContent').addEventListener('input', function() {
        updateContentCounter();
        // إزالة نمط الخطأ عند البدء بالكتابة
        this.classList.remove('border-red-500', 'border-2');
    });
        // Set default notification type
        selectNotificationType(1);

        // Add input event listeners for character counters
        document.getElementById('notificationTitle').addEventListener('input', updateTitleCounter);
        document.getElementById('notificationContent').addEventListener('input', updateContentCounter);

        // Initialize counters
        updateTitleCounter();
        updateContentCounter();

        // Load statistics
        loadUserStatistics();
    });

    // Load user statistics
    async function loadUserStatistics() {
        try {
            // هذه الدالة تحتاج إلى implementation حسب نظامك
            // يمكنك إضافة API endpoint للحصول على الإحصائيات
            document.getElementById('totalUsersCount').textContent = 'جاري التحميل...';
            document.getElementById('studentsCount').textContent = 'جاري التحميل...';
            document.getElementById('instructorsCount').textContent = 'جاري التحميل...';

            // Simulate loading statistics
            setTimeout(() => {
                document.getElementById('totalUsersCount').textContent = '150';
                document.getElementById('studentsCount').textContent = '120';
                document.getElementById('instructorsCount').textContent = '30';
            }, 1000);

        } catch (error) {
            console.error('Error loading statistics:', error);
        }
    }

    // Character counters
    function updateTitleCounter() {
        const title = document.getElementById('notificationTitle');
        const counter = document.getElementById('titleCounter');
        counter.textContent = `${title.value.length}/200`;
    }

    function updateContentCounter() {
        const content = document.getElementById('notificationContent');
        const counter = document.getElementById('contentCounter');
        counter.textContent = `${content.value.length}/2000`;
    }

    // Notification type selection
    let selectedNotificationType = 1; // Default: Promotional

    function selectNotificationType(type) {
        selectedNotificationType = type;

        // Remove selected class from all radio cards
        document.querySelectorAll('.radio-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Add selected class to clicked card
        const selectedCard = event.currentTarget;
        selectedCard.classList.add('selected');
    }

    // Recipient selection
    let selectedRecipients = new Set(['all']);

    function toggleRecipient(type) {
        const card = event.currentTarget;

        if (type === 'all') {
            // If selecting 'all', clear others
            selectedRecipients.clear();
            selectedRecipients.add('all');

            // Update UI
            document.querySelectorAll('.checkbox-card').forEach(c => {
                c.classList.remove('selected');
                const checkbox = c.querySelector('.w-5.h-5');
                const checkIcon = c.querySelector('.fa-check');

                if (checkbox) {
                    checkbox.style.borderColor = '#9ca3af';
                    checkbox.style.backgroundColor = 'transparent';
                }
                if (checkIcon) checkIcon.classList.add('hidden');
            });

            // Select 'all'
            card.classList.add('selected');
            const checkbox = card.querySelector('.w-5.h-5');
            const checkIcon = card.querySelector('.fa-check');

            if (checkbox) {
                checkbox.style.borderColor = '#2563eb';
                checkbox.style.backgroundColor = '#2563eb';
            }
            if (checkIcon) checkIcon.classList.remove('hidden');
        } else {
            // If selecting specific recipient, remove 'all'
            selectedRecipients.delete('all');
            selectedRecipients.add(type);

            // Update UI for 'all'
            const allCard = document.querySelector('.checkbox-card[onclick="toggleRecipient(\'all\')"]');
            if (allCard) {
                allCard.classList.remove('selected');
                const allCheckbox = allCard.querySelector('.w-5.h-5');
                const allCheckIcon = allCard.querySelector('.fa-check');

                if (allCheckbox) {
                    allCheckbox.style.borderColor = '#9ca3af';
                    allCheckbox.style.backgroundColor = 'transparent';
                }
                if (allCheckIcon) allCheckIcon.classList.add('hidden');
            }

            // Toggle current card
            const isSelected = card.classList.contains('selected');

            if (isSelected) {
                card.classList.remove('selected');
                selectedRecipients.delete(type);
                const checkbox = card.querySelector('.w-5.h-5');
                const checkIcon = card.querySelector('.fa-check');

                if (checkbox) {
                    checkbox.style.borderColor = '#9ca3af';
                    checkbox.style.backgroundColor = 'transparent';
                }
                if (checkIcon) checkIcon.classList.add('hidden');
            } else {
                card.classList.add('selected');
                selectedRecipients.add(type);
                const checkbox = card.querySelector('.w-5.h-5');
                const checkIcon = card.querySelector('.fa-check');

                if (checkbox) {
                    checkbox.style.borderColor = '#2563eb';
                    checkbox.style.backgroundColor = '#2563eb';
                }
                if (checkIcon) checkIcon.classList.remove('hidden');
            }

            // If no recipients selected, select 'all'
            if (selectedRecipients.size === 0) {
                toggleRecipient('all');
            }
        }
    }

    // Send option selection
    function toggleSendOption(type) {
        const card = event.currentTarget;
        const checkbox = document.getElementById(type === 'email' ? 'sendEmailOption' : 'sendNotificationOption');

        if (checkbox) {
            checkbox.checked = !checkbox.checked;
        }

        const isSelected = card.classList.contains('selected');

        if (isSelected) {
            card.classList.remove('selected');
            const checkIcon = card.querySelector('.fa-check');
            const box = card.querySelector('.w-5.h-5');

            if (box) {
                box.style.borderColor = '#9ca3af';
                box.style.backgroundColor = 'transparent';
            }
            if (checkIcon) checkIcon.classList.add('hidden');
        } else {
            card.classList.add('selected');
            const checkIcon = card.querySelector('.fa-check');
            const box = card.querySelector('.w-5.h-5');

            if (box) {
                box.style.borderColor = '#2563eb';
                box.style.backgroundColor = '#2563eb';
            }
            if (checkIcon) checkIcon.classList.remove('hidden');
        }
    }

    // Apply template
    function applyTemplate(templateType) {
        const templates = {
            'welcome': {
                title: 'ترحيب بالطلاب الجدد',
                content: 'مرحبًا بك في منصتنا! نحن سعداء بانضمامك إلينا. استكشف دوراتنا وابدأ رحلة التعلم اليوم.\n\nمع أطيب التحيات،\nفريق الدعم',
                type: 1 // Promotional
            },
            'new_course': {
                title: 'إعلان عن دورة جديدة في البرمجة',
                content: 'يسرنا الإعلان عن إطلاق دورة جديدة في مجال تطوير الويب. ستتعلم في هذه الدورة أحدث تقنيات البرمجة وبناء تطبيقات ويب متكاملة.\n\nسجل الآن واحصل على خصم 20% للطلاب الجدد!\n\nمع تحياتنا،\nفريق المنصة',
                type: 2 // Course
            },
            'system_update': {
                title: 'تحديثات النظام القادمة',
                content: 'سيتم إجراء بعض التحديثات على النظام يوم الجمعة القادم من الساعة 2-4 صباحًا. خلال هذا الوقت، قد يكون النظام غير متاح بشكل مؤقت.\n\nنعتذر مقدماً عن أي إزعاج ونعمل على تحسين تجربتك.\n\nشكرًا لتفهمك،\nفريق الدعم الفني',
                type: 0 // System
            }
        };

        const template = templates[templateType];
        if (template) {
            document.getElementById('notificationTitle').value = template.title;
            document.getElementById('notificationContent').value = template.content;
            
            // Set notification type
            selectNotificationType(template.type);

            // Update counters
            updateTitleCounter();
            updateContentCounter();

            // Show success message
            showAlert('success', 'تم تعبئة النموذج بنجاح! يمكنك تعديل المحتوى حسب الحاجة.');
        }
    }

    // Send notification
    // Send notification
    async function sendNotification() {
        const titleInput = document.getElementById('notificationTitle');
        const contentInput = document.getElementById('notificationContent');

        const title = titleInput.value.trim();
        const content = contentInput.value.trim();
        const sendEmail = document.getElementById('sendEmailOption').checked;
        const sendNotificationOption = document.getElementById('sendNotificationOption').checked;

        // إزالة أي أنماط خطأ سابقة
        titleInput.classList.remove('border-red-500', 'border-2');
        contentInput.classList.remove('border-red-500', 'border-2');

        // التحقق من الصحة
        const errors = [];
        if (!title) {
            errors.push('عنوان الإشعار مطلوب');
            titleInput.classList.add('border-red-500', 'border-2');
        }

        if (!content) {
            errors.push('محتوى الإشعار مطلوب');
            contentInput.classList.add('border-red-500', 'border-2');
        }

        if (!sendEmail && !sendNotificationOption) {
            errors.push('يرجى اختيار نوع الإرسال على الأقل (بريد إلكتروني أو إشعار)');
        }

        if (errors.length > 0) {
            showAlert('error', errors.join('<br>'));
            return;
        }

        let target;
        if (selectedRecipients.has('all')) {
            target = 0; // AllUsers
        } else if (selectedRecipients.has('students')) {
            target = 1; // StudentsOnly
        } else if (selectedRecipients.has('instructors')) {
            target = 2; // InstructorsOnly
        } else {
            target = 0; // AllUsers
        }

        const request = {
            title: title,
            message: content,
            type: selectedNotificationType,
            target: target,
            sendEmail: sendEmail,
            sendNotification: sendNotificationOption
        };

        try {
            showAlert('info', 'جاري إرسال الإشعارات...');

            // إضافة anti-forgery token
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const response = await fetch('/Admin/Notification/SendNotification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify(request)
            });

            const result = await response.json();

            if (result.success) {
                showAlert('success', result.message || 'تم إرسال الإشعارات بنجاح');

                // عرض النتائج التفصيلية
                if (result.data) {
                    const data = result.data;
                    const details = `
    العدد الكلي للمستخدمين: ${data.totalUsers}
    الإشعارات المرسلة: ${data.notificationsSent}
    البريد الإلكتروني المرسل: ${data.emailsSent}
    الإشعارات الفاشلة: ${data.failedNotifications}
    البريد الإلكتروني الفاشل: ${data.failedEmails}
                    `.trim();

                    setTimeout(() => {
                    }, 1500);
                }

                if (result.data && (result.data.notificationsSent > 0 || result.data.emailsSent > 0)) {
                    setTimeout(() => {
                        resetForm();
                    }, 3000);
                }
            } else {
                let errorMessage = result.message || 'حدث خطأ أثناء الإرسال';
                if (result.errors && result.errors.length > 0) {
                    errorMessage += '<br>' + result.errors.join('<br>');
                }
                showAlert('error', errorMessage);
            }
        } catch (error) {
            console.error('Error sending notification:', error);
            showAlert('error', 'حدث خطأ أثناء إرسال الإشعارات: ' + error.message);
        }
    }

    // Reset form
    function resetForm() {
        document.getElementById('notificationTitle').value = '';
        document.getElementById('notificationContent').value = '';
        
        // Reset to default notification type
        selectNotificationType(1);

        // Remove error styles
        document.getElementById('notificationTitle').classList.remove('border-red-500');
        document.getElementById('notificationContent').classList.remove('border-red-500');

        // Update counters
        updateTitleCounter();
        updateContentCounter();

        showAlert('success', 'تم إعادة تعيين النموذج بنجاح');
    }

    // Show alert message
    function showAlert(type, message) {
        // Remove existing alerts
        document.querySelectorAll('.custom-alert').forEach(alert => alert.remove());

        // Create alert element
        const alert = document.createElement('div');
        alert.className = `custom-alert fixed top-6 left-6 right-6 md:left-auto md:right-6 md:w-96 p-4 rounded-xl shadow-lg z-50 transform transition-all duration-300 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            type === 'info' ? 'bg-blue-500 text-white' :
            'bg-gray-500 text-white'
        }`;
        alert.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' :
                    type === 'error' ? 'fa-exclamation-circle' :
                    type === 'info' ? 'fa-info-circle' :
                    'fa-bell'
                } ml-3"></i>
                <span class="flex-1" style="white-space: pre-line;">${message}</span>
                <button class="mr-auto text-white opacity-70 hover:opacity-100" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        // Add to page
        document.body.appendChild(alert);

        // Auto remove after 8 seconds
        setTimeout(() => {
            if (alert.parentElement) {
                alert.remove();
            }
        }, 8000);
    }
</script>